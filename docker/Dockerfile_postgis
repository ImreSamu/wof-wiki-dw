FROM mdillon/postgis:9.6

ENV LANG=C.UTF-8 \
    LC_ALL=C.UTF-8

RUN apt-get update && \
    apt-get install -y --no-install-recommends \
      apt-utils\
      build-essential \
      ca-certificates \
      cmake \
      git \
      m4 \
      pgxnclient \
      postgresql-$PG_MAJOR-plv8 \      
      postgresql-plpython-$PG_MAJOR \
      postgresql-server-dev-$PG_MAJOR \
   && rm -rf /var/lib/apt/lists/*

# install madlib
RUN pgxn install madlib=1.12

# install cartodb-postgresql
RUN   mkdir -p /cartodb-postgresql \
   && git clone --depth 1 --branch master https://github.com/CartoDB/cartodb-postgresql.git /cartodb-postgresql \
   && cd /cartodb-postgresql \
   && make all install

ADD pgtune.py            /pgtune.py
ADD pgtune-db.sh         /docker-entrypoint-initdb.d/pgtune-db.sh

